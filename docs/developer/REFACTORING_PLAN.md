# GSPHCODE Refactoring Plan

**Version**: 1.0  
**Date**: 2025-10-31  
**Estimated Total Time**: 40-60 hours

---

## Executive Summary

This document outlines a comprehensive refactoring plan to improve the GSPHCODE architecture for:
1. **Easy addition of samples and production simulations** - Organized by physics category
2. **Easy addition of new SPH algorithms** - Clear modular structure with templates
3. **Modern Python tooling** - Migration from pip to uv for analysis toolkit
4. **Comprehensive documentation** - Step-by-step guides for all common tasks
5. **Multi-dimensional support** - CMake BUILD_DIM system for 1D/2D/3D ‚úÖ COMPLETE
6. **Clean architecture** - Remove all legacy files to validate new structure

---

## Table of Contents

1. [Current Pain Points](#current-pain-points)
2. [Proposed Folder Structure](#proposed-folder-structure)
3. [Migration Tasks](#migration-tasks)
4. [Python Modernization](#python-modernization)
5. [Dimension Handling](#dimension-handling)
6. [Documentation Improvements](#documentation-improvements)
7. [Implementation Timeline](#implementation-timeline)

---

## Current Pain Points

### 1. Flat Sample Organization (22 files in `src/sample/`)
- ‚ùå Hard to find related simulations
- ‚ùå No categorization by physics type
- ‚ùå Shock tube variants scattered (6 different versions)
- ‚ùå No clear separation between test/benchmark/production
- ‚ö†Ô∏è **LEGACY CODE - TO BE REMOVED** to validate new architecture

### 2. Production Sims Mixed Concerns
- ‚ùå Razor thin disk simulations in production_sims/
- ‚ùå No clear criteria for "production" vs "sample"
- ‚ùå Some production sims could be templates for samples
- ‚ö†Ô∏è **LEGACY CODE - TO BE REMOVED** after migration to `src/samples/production/`

### 3. Algorithm Organization
- ‚ùå GSPH, DISPH, SSPH modules in different directories
- ‚ùå No clear guide for adding new SPH variants
- ‚ùå Module registration pattern not well documented

### 4. Python Analysis Toolkit
- ‚ùå Using pip with requirements.txt (slow, no lockfile)
- ‚ùå No virtual environment management in Nix
- ‚ùå Dependencies not pinned properly

### 5. Dimension Handling (Critical!)
- ‚úÖ **SOLVED**: CMake BUILD_DIM option implemented (Phase 4.5 complete)
- ‚úÖ **Three executables**: sph1d, sph2d, sph3d
- ‚úÖ **Validated**: All dimensions tested and working
- üìñ **Documented**: DIMENSION_BUILD_SYSTEM.md created
- ‚ö†Ô∏è **Next**: Remove legacy files to ensure new architecture works

### 6. Documentation Gaps
- ‚úÖ Good: DEVELOPER_GUIDE.md, QUICK_REFERENCE.md exist
- ‚ùå No architecture decision records
- ‚ùå No templates for new simulations
- ‚ùå No contribution guide

---

## Proposed Folder Structure

### Option A: Physics-Based Organization (Recommended)

```
sphcode/
‚îú‚îÄ‚îÄ üìÑ Documentation
‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îú‚îÄ‚îÄ DEVELOPER_GUIDE.md
‚îÇ   ‚îú‚îÄ‚îÄ QUICK_REFERENCE.md
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md
‚îÇ   ‚îú‚îÄ‚îÄ DOCUMENTATION.md
‚îÇ   ‚îú‚îÄ‚îÄ REFACTORING_PLAN.md (this file)
‚îÇ   ‚îî‚îÄ‚îÄ CONTRIBUTING.md (new)
‚îÇ
‚îú‚îÄ‚îÄ üîß Build & Config
‚îÇ   ‚îú‚îÄ‚îÄ CMakeLists.txt
‚îÇ   ‚îú‚îÄ‚îÄ Makefile
‚îÇ   ‚îú‚îÄ‚îÄ flake.nix
‚îÇ   ‚îú‚îÄ‚îÄ pyproject.toml (new - for uv)
‚îÇ   ‚îî‚îÄ‚îÄ uv.lock (new - generated by uv)
‚îÇ
‚îú‚îÄ‚îÄ üìÅ Source Code (C++)
‚îÇ   ‚îú‚îÄ‚îÄ include/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/                    # Core simulation classes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ simulation.hpp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ solver.hpp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ particle.hpp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ parameters.hpp
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modules/                 # Module system
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ module.hpp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ module_factory.hpp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pre_interaction.hpp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fluid_force.hpp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gravity_force.hpp
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ timestep.hpp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ heating_cooling.hpp
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ algorithms/              # SPH algorithm variants
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ssph/                # Standard SPH
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ disph/               # Density Independent SPH
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gsph/                # Godunov SPH
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kernel/                  # Kernel functions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tree/                    # Spatial tree structures
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bhtree.hpp
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exhaustive_search.hpp
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utilities/               # Helper utilities
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ samples/                 # Sample registry
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ sample_registry.hpp
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ core/                    # Core implementations
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ main.cpp
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ solver.cpp
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ simulation.cpp
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ output.cpp
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ modules/                 # Base module implementations
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ timestep.cpp
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ pre_interaction.cpp
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ algorithms/              # Algorithm implementations
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ssph/               # Standard SPH modules
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ disph/               # DISPH modules
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ d_pre_interaction.cpp
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ d_fluid_force.cpp
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CMakeLists.txt
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ gsph/                # GSPH modules
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ g_pre_interaction.cpp
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ g_fluid_force.cpp
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ g_riemann_solver.cpp
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ CMakeLists.txt
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ tree/                    # Tree implementations
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ bhtree.cpp
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ exhaustive_search.cpp
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ sample/ ‚ö†Ô∏è LEGACY - TO BE REMOVED
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [old sample files to be deleted]
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ production_sims/ ‚ö†Ô∏è LEGACY - TO BE REMOVED
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ [old production files to be deleted]
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ samples/                 # ‚≠ê NEW ORGANIZATION
‚îÇ           ‚îú‚îÄ‚îÄ CMakeLists.txt       # Glob all subdirectories
‚îÇ           ‚îÇ
‚îÇ           ‚îú‚îÄ‚îÄ benchmarks/          # Standard test problems
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ shock_tubes/
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sod_shock_tube.cpp
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strong_shock.cpp
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ with_heating_cooling.cpp
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ astro_units.cpp
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2d_shock_tube.cpp
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ sedov_taylor/
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sedov_1d.cpp
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sedov_2d.cpp
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ gresho_vortex/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gresho_chan_vortex.cpp
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ evrard_collapse/
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ evrard.cpp
‚îÇ           ‚îÇ
‚îÇ           ‚îú‚îÄ‚îÄ instabilities/       # Hydrodynamic instabilities
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ kelvin_helmholtz/
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ khi_2d.cpp
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ rayleigh_taylor/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ (future)
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ perturbation_tests/
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ purtabation_damping.cpp
‚îÇ           ‚îÇ
‚îÇ           ‚îú‚îÄ‚îÄ gravity/             # Gravity-dominated
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ lane_emden/
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lane_emden_1d.cpp
‚îÇ           ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lane_emden_2d.cpp
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ pairing_instability/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pairing_instability.cpp
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ hydrostatic/
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ hydrostatic.cpp
‚îÇ           ‚îÇ
‚îÇ           ‚îú‚îÄ‚îÄ disks/               # Disk simulations
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ thin_disk_3d/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ thin_disk_3d.cpp
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ thin_slice/
‚îÇ           ‚îÇ       ‚îú‚îÄ‚îÄ thin_slice_poly_2_5d.cpp
‚îÇ           ‚îÇ       ‚îú‚îÄ‚îÄ thin_slice_relax.cpp
‚îÇ           ‚îÇ       ‚îú‚îÄ‚îÄ thin_slice_anisotropic_relax.cpp
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ README.md
‚îÇ           ‚îÇ
‚îÇ           ‚îú‚îÄ‚îÄ validation/          # Code validation tests
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ vacuum_test/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vacuum_test.cpp
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ cooling_test/
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ cool_test.cpp
‚îÇ           ‚îÇ
‚îÇ           ‚îú‚îÄ‚îÄ templates/           # ‚≠ê NEW: Reusable templates
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ shock_tube_template.hpp
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ disk_template.hpp
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ           ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ production/          # Production simulations
‚îÇ               ‚îú‚îÄ‚îÄ razor_thin_hvcc/
‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ razor_thin_hvcc.cpp
‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ razor_thin_hvcc_debug.cpp
‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ               ‚îú‚îÄ‚îÄ razor_thin_relaxation/
‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ razor_thin_sg_relaxation.cpp
‚îÇ               ‚îî‚îÄ‚îÄ blast_waves/
‚îÇ                   ‚îî‚îÄ‚îÄ test_razor_thin_blast_wave.cpp
‚îÇ
‚îú‚îÄ‚îÄ üìÇ Configuration Files
‚îÇ   ‚îú‚îÄ‚îÄ configs/                     # ‚≠ê NEW: Centralized configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base/                    # Base configuration templates
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ssph_1d.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ssph_2d.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ssph_3d.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ disph_1d.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ disph_2d.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ disph_3d.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gsph_1d.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gsph_2d.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gsph_3d.json
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ benchmarks/              # Benchmark configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shock_tubes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sod.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strong_shock.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sedov_taylor/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ sedov.json
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ production/              # Production configs
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ razor_thin_hvcc/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ hvcc.json
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ sample/ ‚ö†Ô∏è LEGACY - TO BE REMOVED
‚îÇ       ‚îî‚îÄ‚îÄ [old configs to be deleted after migration]
‚îÇ
‚îú‚îÄ‚îÄ üêç Python Analysis Toolkit
‚îÇ   ‚îú‚îÄ‚îÄ analysis/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ readers.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ conservation.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ theoretical.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ plotting.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cli/                     # ‚≠ê NEW: CLI tools
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analyze.py           # Unified CLI
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ animate.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scripts/                 # Legacy scripts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ quick_analysis.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shock_tube_analysis.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ make_animation.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ examples/                # ‚≠ê NEW: Example notebooks
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ example_analysis.ipynb
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shock_tube_tutorial.ipynb
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ khi_visualization.ipynb
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ pyproject.toml               # ‚≠ê NEW: uv configuration
‚îÇ   ‚îú‚îÄ‚îÄ uv.lock                      # ‚≠ê NEW: Lockfile
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt (deprecated)
‚îÇ
‚îú‚îÄ‚îÄ üß™ Testing
‚îÇ   ‚îî‚îÄ‚îÄ test/
‚îÇ       ‚îú‚îÄ‚îÄ unit/                    # Unit tests
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ kernel_test/
‚îÇ       ‚îú‚îÄ‚îÄ integration/             # Integration tests
‚îÇ       ‚îî‚îÄ‚îÄ CMakeLists.txt
‚îÇ
‚îú‚îÄ‚îÄ üìä Results (gitignored)
‚îÇ   ‚îî‚îÄ‚îÄ results/
‚îÇ
‚îî‚îÄ‚îÄ üî® Build Outputs (gitignored)
    ‚îú‚îÄ‚îÄ build/
    ‚îî‚îÄ‚îÄ build_manual/
```

### Key Improvements

1. **Physics-Based Organization**: Samples grouped by physics type (benchmarks, instabilities, gravity, disks)
2. **Production vs Sample Clear**: Production sims in `samples/production/` with README
3. **Algorithm Clarity**: `src/algorithms/{ssph,disph,gsph}/` with consistent structure
4. **Template System**: Reusable templates in `samples/templates/`
5. **Centralized Configs**: Base configs in `configs/base/` for inheritance
6. **Python Modernization**: uv with pyproject.toml, CLI tools organized
7. **Better Testing**: Separate unit/integration tests

---

## Migration Tasks

### Phase 1: Foundation (8-10 hours)

#### Task 1.1: Update Build System (2 hours)
- [ ] Update flake.nix with uv and Python dependencies
- [ ] Add pyproject.toml for Python package management
- [ ] Test Nix build with new structure
- [ ] Update CMakeLists.txt for new directory structure

**Files to modify**:
- `flake.nix`
- `pyproject.toml` (create)
- Root `CMakeLists.txt`

#### Task 1.2: Create New Directory Structure (2 hours)
- [ ] Create new directories: `src/core/`, `src/modules/`, `src/algorithms/`
- [ ] Create new directories: `include/core/`, `include/modules/`, `include/algorithms/`
- [ ] Create `src/samples/benchmarks/`, `src/samples/instabilities/`, etc.
- [ ] Create `configs/base/`
- [ ] Create `analysis/cli/`, `analysis/examples/`

**Commands**:
```bash
mkdir -p src/{core,modules,algorithms/{ssph,disph,gsph},tree}
mkdir -p src/samples/{benchmarks,instabilities,gravity,disks,validation,templates,production}
mkdir -p include/{core,modules,algorithms/{ssph,disph,gsph},tree,utilities}
mkdir -p configs/{base,benchmarks,production}
mkdir -p analysis/{cli,examples}
```

#### Task 1.3: Create Base Configuration Templates (2 hours)
- [ ] Create `configs/base/ssph_{1d,2d,3d}.json`
- [ ] Create `configs/base/disph_{1d,2d,3d}.json`
- [ ] Create `configs/base/gsph_{1d,2d,3d}.json`
- [ ] Document configuration inheritance pattern
- [ ] Add JSON schema for validation (optional)

#### Task 1.4: Documentation Setup (2-4 hours)
- [ ] Create `CONTRIBUTING.md`
- [ ] Create `samples/templates/README.md`
- [ ] Create category READMEs in each sample subdirectory
- [ ] Update `DEVELOPER_GUIDE.md` with new structure

---

### Phase 2: Code Migration (16-20 hours)

#### Task 2.1: Migrate Core Files (3 hours)
- [ ] Move core headers to `include/core/`
- [ ] Move core source to `src/core/`
- [ ] Update include paths in all files
- [ ] Test compilation

**Files to move**:
- `include/simulation.hpp` ‚Üí `include/core/simulation.hpp`
- `include/solver.hpp` ‚Üí `include/core/solver.hpp`
- `include/particle.hpp` ‚Üí `include/core/particle.hpp`
- `include/parameters.hpp` ‚Üí `include/core/parameters.hpp`
- `src/main.cpp` ‚Üí `src/core/main.cpp`
- `src/solver.cpp` ‚Üí `src/core/solver.cpp`
- `src/simulation.cpp` ‚Üí `src/core/simulation.cpp`

#### Task 2.2: Migrate Module System (3 hours)
- [ ] Move module headers to `include/modules/`
- [ ] Move base module implementations to `src/modules/`
- [ ] Update module factory includes
- [ ] Test compilation

**Files to move**:
- `include/module*.hpp` ‚Üí `include/modules/`
- `include/pre_interaction.hpp` ‚Üí `include/modules/`
- `include/fluid_force.hpp` ‚Üí `include/modules/`
- `src/timestep.cpp` ‚Üí `src/modules/`
- `src/pre_interaction.cpp` ‚Üí `src/modules/`

#### Task 2.3: Migrate Algorithm Implementations (4 hours)
- [ ] Move GSPH files to `src/algorithms/gsph/`
- [ ] Move DISPH files to `src/algorithms/disph/`
- [ ] Create SSPH directory and move base implementations
- [ ] Update algorithm includes
- [ ] Create CMakeLists.txt for each algorithm
- [ ] Test compilation

**Directories to reorganize**:
- `src/gsph/*` ‚Üí `src/algorithms/gsph/`
- `src/disph/*` ‚Üí `src/algorithms/disph/`
- `include/gsph/*` ‚Üí `include/algorithms/gsph/`
- `include/disph/*` ‚Üí `include/algorithms/disph/`

#### Task 2.4: Migrate Sample Simulations (6-10 hours)
**This is the largest migration task**

- [ ] **Shock Tubes** (1 hour): Move 6 shock tube variants to `src/samples/benchmarks/shock_tubes/`
  - sod_shock_tube.cpp (rename from shock_tube.cpp)
  - strong_shock.cpp (from shock_tube_strong_shock.cpp)
  - with_heating_cooling.cpp
  - astro_units.cpp
  - 2d_shock_tube.cpp
  - 2p5d variants

- [ ] **Sedov-Taylor** (30 min): Move to `src/samples/benchmarks/sedov_taylor/`

- [ ] **Instabilities** (1 hour): Move KHI and perturbation tests
  - `khi.cpp` ‚Üí `src/samples/instabilities/kelvin_helmholtz/`
  - `purtabation_damping.cpp` ‚Üí `src/samples/instabilities/perturbation_tests/`

- [ ] **Gravity Simulations** (1 hour): 
  - Lane-Emden variants ‚Üí `src/samples/gravity/lane_emden/`
  - Evrard collapse ‚Üí `src/samples/gravity/evrard_collapse/`
  - Pairing instability ‚Üí `src/samples/gravity/pairing_instability/`
  - Hydrostatic ‚Üí `src/samples/gravity/hydrostatic/`

- [ ] **Disk Simulations** (1 hour):
  - Thin disk 3D ‚Üí `src/samples/disks/thin_disk_3d/`
  - Thin slice variants ‚Üí `src/samples/disks/thin_slice/`

- [ ] **Validation Tests** (30 min):
  - Vacuum test ‚Üí `src/samples/validation/vacuum_test/`
  - Cooling test ‚Üí `src/samples/validation/cooling_test/`

- [ ] **Production Simulations** (1 hour):
  - Move from `src/production_sims/` ‚Üí `src/samples/production/`
  - Organize by project (razor_thin_hvcc, blast_waves, etc.)

- [ ] Update all `REGISTER_SAMPLE` names to reflect new organization
- [ ] Update sample CMakeLists.txt to glob subdirectories
- [ ] Test each sample compiles

---

### Phase 3: Python Modernization (8-10 hours)

#### Task 3.1: Set Up uv (2 hours)
- [ ] Create `pyproject.toml` with project metadata
- [ ] Define dependencies (numpy, scipy, pandas, matplotlib)
- [ ] Define optional dependencies (jupyter, seaborn)
- [ ] Run `uv lock` to generate lockfile
- [ ] Test installation with `uv sync`

**pyproject.toml structure**:
```toml
[project]
name = "gsph-analysis"
version = "1.0.0"
dependencies = [
    "numpy>=1.20.0",
    "scipy>=1.7.0",
    "pandas>=1.3.0",
    "matplotlib>=3.4.0",
]

[project.optional-dependencies]
dev = ["jupyter>=1.0.0", "ipython>=8.0.0"]
viz = ["seaborn>=0.11.0"]

[project.scripts]
gsph-analyze = "analysis.cli.analyze:main"
gsph-animate = "analysis.cli.animate:main"
```

#### Task 3.2: Create Unified CLI (3 hours)
- [ ] Create `analysis/cli/__init__.py`
- [ ] Create `analysis/cli/analyze.py` with subcommands:
  - `gsph-analyze quick <dir>` - Quick conservation analysis
  - `gsph-analyze shock-tube <dir>` - Shock tube comparison
  - `gsph-analyze energy <dir>` - Energy analysis
- [ ] Create `analysis/cli/animate.py` for animations
- [ ] Integrate existing scripts as CLI commands
- [ ] Add argparse/click for argument parsing
- [ ] Test CLI tools

#### Task 3.3: Improve Analysis Package (3 hours)
- [ ] Add type hints to all modules
- [ ] Add docstrings in Google/NumPy format
- [ ] Create `analysis/examples/` with Jupyter notebooks:
  - `shock_tube_tutorial.ipynb`
  - `khi_visualization.ipynb`
  - `energy_conservation.ipynb`
- [ ] Update `analysis/README.md` for uv usage
- [ ] Add pre-commit hooks for Python linting (optional)

#### Task 3.4: Update Nix Integration (2 hours)
- [ ] Update `flake.nix` to include uv
- [ ] Add Python development tools (ruff, mypy)
- [ ] Add Jupyter to dev shell
- [ ] Test Python environment in Nix shell
- [ ] Document uv workflow in DEVELOPER_GUIDE

---

### Phase 4: Testing & Validation (8-12 hours)

#### Task 4.1: Compile All Samples (3 hours)
- [ ] Build with new CMake structure
- [ ] Verify all 22+ samples compile
- [ ] Run smoke tests (1 step per sample)
- [ ] Document any compilation issues

#### Task 4.2: Run Regression Tests (3 hours)
- [ ] Run shock tube benchmarks, compare with previous results
- [ ] Run KHI, compare outputs
- [ ] Run energy conservation tests
- [ ] Verify output formats unchanged

#### Task 4.3: Test Python Analysis (2 hours)
- [ ] Test CLI on all sample types
- [ ] Verify animations work
- [ ] Test Jupyter notebooks
- [ ] Check conservation analysis accuracy

#### Task 4.4: Documentation Review (2-4 hours)
- [ ] Review all documentation for accuracy
- [ ] Test all example commands
- [ ] Have someone else follow QUICK_REFERENCE
- [ ] Fix any unclear instructions

---

### Phase 5: Enhancement (8-10 hours)

#### Task 5.1: Create Sample Templates (3 hours)
- [ ] Create `samples/templates/shock_tube_template.hpp`
- [ ] Create `samples/templates/disk_template.hpp`
- [ ] Add template usage guide
- [ ] Create example using template

**Template structure**:
```cpp
// samples/templates/shock_tube_template.hpp
template<typename Derived>
class ShockTubeTemplate {
protected:
    virtual void set_left_state(...) = 0;
    virtual void set_right_state(...) = 0;
public:
    void load(Simulation* sim, SPHParameters* param) {
        // Common shock tube setup logic
        auto [rho_L, p_L, v_L] = static_cast<Derived*>(this)->set_left_state();
        auto [rho_R, p_R, v_R] = static_cast<Derived*>(this)->set_right_state();
        // ... particle initialization
    }
};

// Usage:
class SodShockTube : public ShockTubeTemplate<SodShockTube> {
    auto set_left_state() { return std::tuple{1.0, 1.0, 0.0}; }
    auto set_right_state() { return std::tuple{0.125, 0.1, 0.0}; }
};
```

#### Task 5.2: Configuration Inheritance (2 hours)
- [ ] Implement JSON inheritance (extends field)
- [ ] Update parameter parser to support inheritance
- [ ] Migrate existing configs to use base templates
- [ ] Test config inheritance

#### Task 5.3: Sample Discovery (2 hours)
- [ ] Add `--list-samples` flag to main
- [ ] Categorize samples by directory
- [ ] Add sample descriptions to registry
- [ ] Format output nicely

#### Task 5.4: Add CONTRIBUTING.md (1-2 hours)
- [ ] Document contribution workflow
- [ ] Add coding standards
- [ ] Add commit message guidelines
- [ ] Add PR template

---

## Python Modernization (uv)

### Why uv?

**Benefits over pip**:
1. **Speed**: 10-100x faster than pip
2. **Lockfile**: `uv.lock` ensures reproducible environments
3. **Resolution**: Better dependency resolution
4. **Modern**: Built in Rust, actively maintained
5. **Pip-compatible**: Drop-in replacement

### Migration Steps

#### 1. Create pyproject.toml

```toml
[project]
name = "gsph-analysis"
version = "1.0.0"
description = "Analysis toolkit for GSPH simulations"
authors = [{name = "Your Name", email = "your.email@example.com"}]
readme = "analysis/README.md"
requires-python = ">=3.9"
license = {text = "MIT"}

dependencies = [
    "numpy>=1.20.0,<2.0.0",
    "scipy>=1.7.0,<2.0.0",
    "pandas>=1.3.0,<3.0.0",
    "matplotlib>=3.4.0,<4.0.0",
]

[project.optional-dependencies]
dev = [
    "jupyter>=1.0.0",
    "ipython>=8.0.0",
    "ruff>=0.1.0",
    "mypy>=1.0.0",
]
viz = [
    "seaborn>=0.11.0",
]

[project.scripts]
gsph-analyze = "analysis.cli.analyze:main"
gsph-animate = "analysis.cli.animate:main"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.ruff]
line-length = 100
target-version = "py39"

[tool.mypy]
python_version = "3.9"
warn_return_any = true
warn_unused_configs = true
```

#### 2. Update flake.nix

```nix
{
  description = "GSPH - Godunov Smoothed Particle Hydrodynamics";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    flake-utils.url = "github:numtide/flake-utils";
  };

  outputs = { self, nixpkgs, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = nixpkgs.legacyPackages.${system};
        
        # C++ dependencies
        cppInputs = with pkgs; [
          cmake
          boost
          llvmPackages_latest.openmp
        ];
        
        # Python dependencies via uv
        pythonEnv = pkgs.mkShell {
          packages = with pkgs; [
            python311
            uv
          ];
        };
        
      in {
        devShells.default = pkgs.mkShell {
          buildInputs = cppInputs ++ (with pkgs; [
            # Build tools
            ninja
            pkg-config
            
            # Debug tools
            gdb
            valgrind
            lldb
            
            # Python tools
            python311
            uv
            
            # Documentation
            doxygen
            graphviz
            
            # Utilities
            jq  # JSON processing
            ffmpeg  # For animations
          ]);
          
          nativeBuildInputs = with pkgs; [
            llvmPackages_latest.clang
          ];
          
          shellHook = ''
            echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
            echo "‚ïë  GSPH Development Environment         ‚ïë"
            echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
            echo ""
            echo "C++ Environment:"
            echo "  CMake: $(cmake --version | head -n1 | cut -d' ' -f3)"
            echo "  Clang: $(clang --version | head -n1 | cut -d' ' -f4)"
            echo ""
            echo "Python Environment:"
            echo "  Python: $(python --version | cut -d' ' -f2)"
            echo "  uv: $(uv --version | cut -d' ' -f2)"
            echo ""
            echo "Quick Start:"
            echo "  Build C++:    mkdir -p build && cd build && cmake .. && make"
            echo "  Setup Python: uv sync"
            echo "  Run analysis: uv run gsph-analyze quick results/shock_tube"
            echo "  Run example:  ./build/sph shock_tube configs/benchmarks/shock_tubes/sod.json 8"
            echo ""
            
            # Set OpenMP threads
            export OMP_NUM_THREADS=''${OMP_NUM_THREADS:-$(nproc)}
            
            # Add build to PATH if exists
            if [ -d "build" ]; then
              export PATH="$PWD/build:$PATH"
            fi
            
            # Python path for development
            export PYTHONPATH="$PWD:$PYTHONPATH"
          '';
        };
        
        packages.default = pkgs.stdenv.mkDerivation {
          pname = "gsphcode";
          version = "1.0.0";
          src = ./.;
          
          buildInputs = cppInputs;
          nativeBuildInputs = [ pkgs.cmake pkgs.llvmPackages_latest.clang ];
          
          cmakeFlags = [
            "-DCMAKE_CXX_STANDARD=14"
          ];
          
          installPhase = ''
            mkdir -p $out/bin
            cp sph $out/bin/
          '';
        };
      }
    );
}
```

#### 3. Workflow with uv

```bash
# Install dependencies
uv sync

# Add new dependency
uv add scipy

# Add dev dependency
uv add --dev pytest

# Run script
uv run analysis/cli/analyze.py

# Run installed command
uv run gsph-analyze quick results/shock_tube

# Activate virtual environment
source .venv/bin/activate
python analysis/cli/analyze.py

# Update dependencies
uv lock --upgrade
```

---

## Documentation Improvements

### New Documents to Create

#### 1. CONTRIBUTING.md
```markdown
# Contributing to GSPHCODE

## Adding a New Sample Simulation

See [QUICK_REFERENCE.md](QUICK_REFERENCE.md) for 5-minute guide.

**Steps**:
1. Choose category (benchmarks/instabilities/gravity/disks/validation)
2. Create directory: `src/samples/<category>/<simulation_name>/`
3. Create `<simulation_name>.cpp` with `load_<simulation_name>` function
4. Register: `REGISTER_SAMPLE("simulation_name", load_simulation_name)`
5. Create config: `configs/<category>/<simulation_name>.json`
6. Rebuild: `cd build && make`
7. Test: `./sph simulation_name configs/.../simulation_name.json 8`

## Adding a New SPH Algorithm

See [DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md) for detailed guide.
```

#### 2. Sample Category READMEs

Each sample category should have a README:
- `src/samples/benchmarks/README.md`
- `src/samples/instabilities/README.md`
- `src/samples/gravity/README.md`
- `src/samples/disks/README.md`
- `src/samples/validation/README.md`
- `src/samples/production/README.md`

**Example** (`src/samples/benchmarks/README.md`):
```markdown
# Benchmark Simulations

Standard test problems for validating SPH implementations.

## Shock Tubes
Classic 1D Riemann problems testing shock capturing and contact discontinuities.

- **sod_shock_tube** - Standard Sod problem (œÅ_L=1, œÅ_R=0.125)
- **strong_shock** - High compression ratio shock
- **with_heating_cooling** - Shock with thermal processes
- **astro_units** - Shock in astrophysical units

## Sedov-Taylor
Self-similar blast wave solution.

## Gresho-Chan Vortex
2D vortex stability test for advection and pressure gradients.

## Evrard Collapse
Spherical collapse test for gravity + hydro.
```

---

## Dimension Handling

### Current Problem: Compile-Time DIM Constant

**Critical Limitation**: The spatial dimension is hardcoded at compile time in `include/utilities/defines.hpp`:

```cpp
#define DIM 1  // Must rebuild entire project to change!
```

**Impact**:
- ‚ùå Cannot run 1D and 2D simulations from the same build
- ‚ùå Must recompile entire project (~5 minutes) to switch dimensions
- ‚ùå Test failures when config dimension ‚â† DIM
- ‚ùå Confusing user experience

See [DIMENSION_HANDLING.md](DIMENSION_HANDLING.md) for complete analysis.

### Recommended Solution: CMake Build Dimensions

**Approach**: Build separate binaries for each dimension with CMake option.

#### Implementation (4-6 hours)

```cmake
# Root CMakeLists.txt
option(BUILD_DIM "Spatial dimension (1, 2, or 3)" 2)

if(NOT BUILD_DIM MATCHES "^[123]$")
    message(FATAL_ERROR "BUILD_DIM must be 1, 2, or 3")
endif()

message(STATUS "Building for ${BUILD_DIM}D simulations")
add_compile_definitions(DIM=${BUILD_DIM})

# Set executable name with dimension suffix
set_target_properties(sph PROPERTIES OUTPUT_NAME "sph${BUILD_DIM}d")
```

#### Usage

```bash
# Build all dimensions
mkdir -p build_1d build_2d build_3d

cmake -DBUILD_DIM=1 -B build_1d && make -C build_1d -j8
cmake -DBUILD_DIM=2 -B build_2d && make -C build_2d -j8
cmake -DBUILD_DIM=3 -B build_3d && make -C build_3d -j8

# Copy to bin/
cp build_1d/sph1d bin/
cp build_2d/sph2d bin/
cp build_3d/sph3d bin/

# Use appropriate binary
./bin/sph1d shock_tube config_1d.json 4
./bin/sph2d khi config_2d.json 8
./bin/sph3d evrard config_3d.json 8
```

#### Helper Scripts

```bash
# scripts/build_all_dimensions.sh
for DIM in 1 2 3; do
    cmake -DBUILD_DIM=$DIM -B build_${DIM}d
    make -C build_${DIM}d -j8
    cp build_${DIM}d/sph${DIM}d bin/
done

# scripts/smart_run.sh - Auto-detect dimension from config
CONFIG=$2
DIM=$(python3 -c "import json; print(len(json.load(open('$CONFIG'))['rangeMax']))")
exec ./bin/sph${DIM}d "$@"
```

#### Better Error Messages

```cpp
// In solver.cpp
if (rangeMax.size() != DIM) {
    std::ostringstream err;
    err << "‚ùå Dimension Mismatch\n\n"
        << "Config: " << rangeMax.size() << "D, Binary: " << DIM << "D\n\n"
        << "Solutions:\n"
        << "  1. Use: sph" << rangeMax.size() << "d " << sample_name << " " << config_file << "\n"
        << "  2. Rebuild: cmake -DBUILD_DIM=" << rangeMax.size() << " -B build_" << rangeMax.size() << "d\n"
        << "  3. Auto: ./scripts/smart_run.sh " << sample_name << " " << config_file << "\n";
    throw DimensionMismatchException(err.str());
}
```

### Future: Runtime Dimension Selection

**Long-term goal** (Phase 5+): Single binary supporting all dimensions.

**Approach**: Template metaprogramming + std::variant dispatcher

```cpp
template<int D> class SimulationND { /* ... */ };

class Simulation {
    std::variant<SimulationND<1>, SimulationND<2>, SimulationND<3>> impl;
    
    Simulation(int dim, ...) {
        switch(dim) {
            case 1: impl = SimulationND<1>(...); break;
            case 2: impl = SimulationND<2>(...); break;
            case 3: impl = SimulationND<3>(...); break;
        }
    }
    
    void run() { std::visit([](auto& s) { s.run(); }, impl); }
};
```

**Benefits**: 
- ‚úÖ Single binary for all dimensions
- ‚úÖ Auto-detect from config
- ‚úÖ Better UX

**Cost**: 20-30 hours refactoring, requires C++17

---

## Implementation Timeline

### Week 1: Foundation
- **Days 1-2**: Update build system (flake.nix, pyproject.toml, CMake)
- **Days 3-4**: Create directory structure
- **Days 4-5**: Create base configurations and documentation

### Week 2: Core Migration
- **Days 6-7**: Migrate core files and module system
- **Days 8-9**: Migrate algorithm implementations
- **Day 10**: Initial testing

### Week 3: Sample Migration
- **Days 11-12**: Migrate benchmark samples
- **Days 13-14**: Migrate physics samples (instabilities, gravity, disks)
- **Day 15**: Migrate production sims and validation tests

### Week 4: Python & Testing
- **Days 16-17**: Python modernization (uv setup, CLI)
- **Days 18-19**: Comprehensive testing and validation
- **Day 20**: Documentation review and polish

### Week 5: Enhancements (Optional)
- **Days 21-22**: Sample templates
- **Days 23-24**: Configuration inheritance
- **Day 25**: Sample discovery and final touches

---

## Success Criteria

### Must Have (Phase 1-4)
- ‚úÖ All existing samples compile and run
- ‚úÖ New folder structure in place
- ‚úÖ Python analysis works with uv
- ‚úÖ Documentation updated
- ‚úÖ Nix flake works with all dependencies

### Should Have (Phase 5)
- ‚úÖ Sample templates implemented
- ‚úÖ Configuration inheritance working
- ‚úÖ CLI tools functional
- ‚úÖ Category READMEs written

### Nice to Have
- ‚úÖ JSON schema validation
- ‚úÖ Sample discovery (--list-samples)
- ‚úÖ Pre-commit hooks for linting
- ‚úÖ Architecture decision records

---

## Risk Mitigation

### Risk 1: Breaking Existing Workflows
**Mitigation**: 
- Keep backward compatibility where possible
- Maintain old directory structure temporarily
- Document migration guide for users

### Risk 2: Time Overrun
**Mitigation**:
- Prioritize phases 1-3 (foundation + migration)
- Phase 4-5 can be done incrementally
- Get basic structure working first

### Risk 3: Compilation Issues
**Mitigation**:
- Test compilation frequently
- Migrate one category at a time
- Keep detailed notes of include path changes

---

## Next Steps

1. **Review this plan** with team/stakeholders
2. **Create feature branch**: `git checkout -b refactor/new-structure`
3. **Start with Phase 1, Task 1.1**: Update flake.nix
4. **Commit frequently** with descriptive messages
5. **Test at each milestone** before proceeding

---

**Questions? See [DEVELOPER_GUIDE.md](DEVELOPER_GUIDE.md) or open an issue.**
