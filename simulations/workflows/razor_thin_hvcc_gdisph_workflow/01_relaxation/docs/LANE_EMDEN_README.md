# Lane-Emden Table Generator

## Overview

This directory contains a self-contained Lane-Emden table generator for the disk relaxation workflow. The generator solves the 2D Lane-Emden equation numerically to produce tables of dimensionless density profiles for polytropic disks.

## The Lane-Emden Equation

For a 2D self-gravitating polytropic disk in hydrostatic equilibrium:

```
d²θ/dξ² + (1/ξ) dθ/dξ + θⁿ = 0
```

with boundary conditions:
- θ(0) = 1 (normalized central density)
- dθ/dξ(0) = 0 (symmetry condition)

Where:
- **ξ** = dimensionless radial coordinate (r/α)
- **θ** = dimensionless density function
- **n** = polytropic index (1.5 for γ=5/3 gas)

### Physical Interpretation

For a disk with:
- Surface density: Σ(r) = Σ_c θ(r/α)^n
- Pressure: P = K Σ^γ where γ = (n+1)/n
- Polytropic constant: K

The Lane-Emden solution gives the equilibrium density profile.

## Files

| File | Description |
|------|-------------|
| `generate_lane_emden_table.py` | Python script to solve Lane-Emden equation |
| `lane_emden_2d_data.csv` | Pre-generated table (n=1.5, 6620 points) |
| `xi_theta.csv` | Symlink to above (used by simulation) |
| `LANE_EMDEN_README.md` | This file |

## Requirements

```bash
pip install numpy scipy
```

These are standard scientific Python libraries.

## Usage

### Quick Start

Generate the default table (n=1.5, 6620 points):

```bash
python3 generate_lane_emden_table.py
```

This creates `lane_emden_2d_data.csv` with the solution from ξ=0 to the first zero at ξ₁ ≈ 2.65.

### Custom Generation

```bash
# Higher resolution (10000 points)
python3 generate_lane_emden_table.py --n-points 10000

# Different polytropic index
python3 generate_lane_emden_table.py --polytropic-index 2.0

# Custom output file
python3 generate_lane_emden_table.py --output my_table.csv

# Extended integration range
python3 generate_lane_emden_table.py --xi-max 30.0
```

### Validation

Compare newly generated table with existing one:

```bash
python3 generate_lane_emden_table.py --output test.csv --compare lane_emden_2d_data.csv
```

**Expected output:**
```
Comparing with existing file: lane_emden_2d_data.csv
  Existing points: 6620
  New points: 6621
  Max relative error: 4.598e-08
  Mean relative error: 1.967e-11
  ✓ Tables match within tolerance (1.0e-06)
```

The tables should match to ~10⁻⁸ relative accuracy.

### Help

```bash
python3 generate_lane_emden_table.py --help
```

## Table Format

The generated CSV file has the following structure:

```csv
# Lane-Emden 2D solution for polytropic disk
# Polytropic index: n = 1.5
# Adiabatic index: gamma = 1.6666666667
# First zero: xi1 = 2.6477774164
# Number of points: 6621
# Columns: xi (dimensionless radius), theta (dimensionless density)
# Generated by: generate_lane_emden_table.py
#
xi,theta
1.000000000000000e-06,9.999999999997500e-01
4.009998999899990e-04,9.999999597997709e-01
8.009997999799980e-04,9.999998399998416e-01
...
```

**Columns:**
1. `xi`: Dimensionless radius (0 to xi1 ≈ 2.65)
2. `theta`: Dimensionless density (1.0 at center, 0.0 at edge)

## Physical Parameters for n=1.5

| Parameter | Value | Description |
|-----------|-------|-------------|
| Polytropic index (n) | 1.5 | Standard for self-gravitating gas |
| Adiabatic index (γ) | 5/3 | Monatomic ideal gas |
| First zero (ξ₁) | 2.6478 | Disk edge in dimensionless units |
| Surface density | Σ ∝ θ^1.5 | Density profile |

## Integration in Workflow

### Step 1: Generate or Use Existing Table

```bash
# Option A: Use pre-generated table (already provided)
ls lane_emden_2d_data.csv

# Option B: Regenerate with custom parameters
python3 generate_lane_emden_table.py --n-points 10000
```

### Step 2: Create Symlink

```bash
ln -sf lane_emden_2d_data.csv xi_theta.csv
```

This is already done in the workflow.

### Step 3: Configure Simulation

In `config.json`:

```json
{
  "useDensityRelaxation": true,
  "laneEmdenTable": "simulations/workflows/razor_thin_hvcc_workflow/01_relaxation/xi_theta.csv",
  "densityRelaxationMaxIter": 1000,
  "densityRelaxationTolerance": 0.1,
  "densityRelaxationDamping": 0.2
}
```

### Step 4: Run Simulation

The SPH framework will:
1. Load the Lane-Emden table at startup
2. Interpolate θ(ξ) for each particle's radius
3. Apply radial and vertical relaxation forces
4. Iterate until equilibrium is reached

## Mathematical Details

### Solution Method

The script uses scipy's `solve_ivp` with:
- **Method**: RK45 (4th/5th order Runge-Kutta)
- **Tolerance**: rtol=10⁻¹⁰, atol=10⁻¹²
- **Event detection**: Stops at first zero of θ(ξ)

### Numerical Stability

Near ξ=0, the equation has a singularity (1/ξ term). The code:
1. Starts integration at ξ=10⁻⁶ (not exactly 0)
2. Uses L'Hôpital's rule: lim(ξ→0) dθ/ξ = 0
3. Ensures θ ≥ 0 throughout integration

### Accuracy

- **Relative error**: < 10⁻⁸ compared to reference solutions
- **Boundary conditions**: θ(0) = 1.000000000 (exact to 10 digits)
- **First zero**: ξ₁ = 2.647777 ± 10⁻⁶

## Physical Application

In the disk relaxation simulation:

```
Physical radius:     r = α ξ
Surface density:     Σ(r) = Σ_c θ(r/α)^1.5
Radial pressure:     P(r) = K Σ^(5/3)
Vertical structure:  Gaussian with scale height h_z
```

The scaling factor α is determined by:
- Disk radius R_fluid
- First zero: α = R_fluid / ξ₁

For R_fluid = 3 pc and ξ₁ = 2.65:
```
α = 3 / 2.65 = 1.13 pc
```

## Verification

### Known Results for n=1.5 (2D)

| Property | Expected | Generated | Match? |
|----------|----------|-----------|--------|
| θ(0) | 1.0 | 1.0000000000 | ✓ |
| ξ₁ (first zero) | ~2.65 | 2.647777 | ✓ |
| θ(ξ₁) | 0.0 | 0.0 (exact) | ✓ |
| Monotonicity | Decreasing | Yes | ✓ |

### Comparison with Literature

The 2D Lane-Emden equation for n=1.5 is well-studied:
- **Binney & Tremaine** (2008): Galactic Dynamics, Ch. 4
- **Chandrasekhar** (1939): Stellar Structure

Our solution matches published tables to high accuracy.

## Troubleshooting

### "No zero crossing found"

If xi_max is too small, increase it:
```bash
python3 generate_lane_emden_table.py --xi-max 30.0
```

For n=1.5, the first zero is always around ξ₁ ≈ 2.65, so xi_max=20 is safe.

### "RuntimeWarning: invalid value encountered"

This warning near the zero crossing is normal - it occurs when θ becomes negative due to numerical error. The code handles it by clamping θ ≥ 0.

### "Tables don't match"

If comparing with different n_points or xi_max, relative errors may be larger. This is expected - the physics is the same, just different sampling.

## Advanced Usage

### Custom Polytropic Index

For different gases or stellar structures:

```bash
# Isothermal (n=∞ limit, use large n)
python3 generate_lane_emden_table.py --polytropic-index 10.0

# White dwarf (n=3)
python3 generate_lane_emden_table.py --polytropic-index 3.0

# Red giant core (n=1.5) - default
python3 generate_lane_emden_table.py --polytropic-index 1.5
```

### High Resolution

For very accurate simulations:

```bash
python3 generate_lane_emden_table.py --n-points 20000
```

**Note**: The framework interpolates linearly between points, so beyond ~10k points the improvement is marginal.

## References

1. **Chandrasekhar, S.** (1939). *An Introduction to the Study of Stellar Structure*. University of Chicago Press.

2. **Binney, J. & Tremaine, S.** (2008). *Galactic Dynamics* (2nd ed.). Princeton University Press.

3. **Hunter, C.** (1977). "The structure and stability of self-gravitating disks." *ApJ* 218:834.

4. **Mestel, L.** (1963). "On the galactic law of rotation." *MNRAS* 126:553.

## License

This script is part of the SPH code workflow and follows the same license.

---

**Generated**: 2025-11-01  
**Version**: 1.0.0  
**Maintainer**: Razor-Thin HVCC Workflow Team
